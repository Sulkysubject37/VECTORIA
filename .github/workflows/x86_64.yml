name: x86_64 SIMD Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-x86_64:
    name: Validate x86_64 (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check CPU Capabilities
        id: cpu-check
        run: |
          if grep -q avx2 /proc/cpuinfo; then
            echo "AVX2_SUPPORTED=true" >> $GITHUB_ENV
            echo "Confirmed: AVX2 is available on this runner."
          else
            echo "AVX2_SUPPORTED=false" >> $GITHUB_ENV
            echo "Warning: AVX2 NOT available on this runner. Falling back to Reference-only."
          fi

      - name: Build and Run SIMD Correctness Harness
        if: env.AVX2_SUPPORTED == 'true'
        run: |
          g++ -std=c++17 -O3 -DVECTORIA_USE_ASM -Icore/include \
            core/src/*.cpp core/src/kernels/*.cpp asm/x86_64/gemm_avx2.S \
            core/tests/test_gemm_simd.cpp -o test_gemm_simd
          ./test_gemm_simd > validation_simd.log

      - name: Build and Run Multi-Op Tests
        run: |
          OPTS=""
          ASM_FILE=""
          if [ "${{ env.AVX2_SUPPORTED }}" = "true" ]; then
            OPTS="-DVECTORIA_USE_ASM"
            ASM_FILE="asm/x86_64/gemm_avx2.S"
          fi
          
          g++ -std=c++17 -O3 $OPTS -Icore/include \
            core/src/*.cpp core/src/kernels/*.cpp $ASM_FILE \
            core/tests/test_multi_op.cpp -o test_multi_op
          ./test_multi_op > validation_multi_op.log

      - name: Build and Run Graph Equivalence Tests
        if: env.AVX2_SUPPORTED == 'true'
        run: |
          g++ -std=c++17 -O3 -DVECTORIA_USE_ASM -Icore/include \
            core/src/*.cpp core/src/kernels/*.cpp asm/x86_64/gemm_avx2.S \
            core/tests/test_graph_equivalence.cpp -o test_graph_equivalence
          ./test_graph_equivalence > validation_equivalence.log

      - name: Build and Run Determinism Stress Tests
        run: |
          OPTS=""
          ASM_FILE=""
          if [ "${{ env.AVX2_SUPPORTED }}" = "true" ]; then
            OPTS="-DVECTORIA_USE_ASM"
            ASM_FILE="asm/x86_64/gemm_avx2.S"
          fi
          
          g++ -std=c++17 -O3 $OPTS -Icore/include \
            core/src/*.cpp core/src/kernels/*.cpp $ASM_FILE \
            core/tests/test_determinism_stress.cpp -o test_determinism_stress
          ./test_determinism_stress > validation_determinism.log

      - name: Upload Validation Logs
        uses: actions/upload-artifact@v4
        with:
          name: x86_64-validation-logs
          path: "*.log"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: pip install pytest

      - name: Build Shared Library for Python Tests
        run: |
          OPTS=""
          ASM_FILE=""
          if [ "${{ env.AVX2_SUPPORTED }}" = "true" ]; then
            OPTS="-DVECTORIA_USE_ASM"
            ASM_FILE="asm/x86_64/gemm_avx2.S"
          fi
          # Force .dylib extension to match runtime.py expectation
          g++ -std=c++17 -shared -fPIC $OPTS -Icore/include \
            core/src/*.cpp core/src/kernels/*.cpp $ASM_FILE \
            -o libvectoria.dylib

      - name: Run Python Tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/python
          pytest python/tests/

      - name: Skip Swift Integration Tests (x86_64 Linux)
        run: |
          echo "Skipping Swift tests on x86_64 Linux: Vectoria Swift bindings are targeted at macOS/ARM64 for this phase."
